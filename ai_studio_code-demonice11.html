<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­åˆ·é¢˜ - æŸ´çŠ¬å¯¿å¸åº— (è±ªåéŸ³æ•ˆç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #FFF3E0;
            background-image: 
                radial-gradient(#FFCC80 15%, transparent 16%), 
                radial-gradient(#FFCC80 15%, transparent 16%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            user-select: none;
            padding-bottom: 120px; /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
        }

        /* æŒ‰é’®ç‚¹å‡»åé¦ˆä¼˜åŒ– */
        .btn-cartoon {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            top: 0;
            cursor: pointer;
        }
        .btn-cartoon:active {
            top: 4px;
            box-shadow: 0 0px 0 0 !important;
            transform: scale(0.98);
        }

        /* ä¸»é¢˜è‰²å®šä¹‰ */
        .theme-n1 { --bg: #FF5252; --shadow: #D32F2F; }
        .theme-n2 { --bg: #7C4DFF; --shadow: #512DA8; }
        .theme-n3 { --bg: #00E676; --shadow: #00C853; }
        .theme-n4 { --bg: #FFAB40; --shadow: #FF6D00; }
        .theme-n5 { --bg: #2979FF; --shadow: #1565C0; }

        .level-card { background-color: var(--bg); box-shadow: 0 6px 0 var(--shadow); }
        
        /* åŠ¨ç”» */
        .mascot-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        .hidden-screen { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .opt-correct { background-color: #C8E6C9 !important; border-color: #4CAF50 !important; color: #1B5E20 !important; }
        .opt-wrong { background-color: #FFCDD2 !important; border-color: #F44336 !important; color: #B71C1C !important; }

        .wood-texture {
            background-color: #D7CCC8;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #EFEBE9 10px, #EFEBE9 20px);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* --- éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ --- */
        .music-player-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        /* æœ¬åœ°æ’­æ”¾å™¨æ¨¡å¼ */
        .local-player {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 3px solid #FFAB40;
            border-radius: 50px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 20px rgba(255, 171, 64, 0.3);
            transition: all 0.3s;
        }
        
        /* Bilibili æ’­æ”¾å™¨å®¹å™¨ */
        .bili-player {
            width: 300px;
            height: 180px;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            border: 4px solid #FB7299; /* Bç«™ç²‰ */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; /* é»˜è®¤éšè— */
        }
        .bili-player.active { display: block; }
        
        .mode-switch-btn {
            background: #333;
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid white;
            opacity: 0.8;
        }
        .mode-switch-btn:hover { opacity: 1; }

        .disc-icon { font-size: 24px; transition: transform 1s linear; }
        .playing-anim { animation: spin 3s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body class="flex flex-col items-center min-h-screen py-6 px-4 text-gray-800">

    <!-- éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶ -->
    <div class="music-player-container">
        <!-- æ¨¡å¼åˆ‡æ¢å¼€å…³ -->
        <button onclick="switchMusicMode()" class="mode-switch-btn" id="mode-btn">
            ğŸ”„ åˆ‡æ¢åˆ° Bilibili åŸå£°
        </button>

        <!-- æ¨¡å¼A: å†…ç½®è½»éŸ³ä¹æ’­æ”¾å™¨ -->
        <div id="player-local" class="local-player">
            <div id="music-disc" class="disc-icon" onclick="toggleLocalMusic()">ğŸ’¿</div>
            <div class="flex flex-col min-w-[120px]">
                <div class="overflow-hidden w-full whitespace-nowrap">
                    <span id="music-title" class="text-xs font-bold text-gray-700 block">è½»éŸ³ä¹æ¨¡å¼</span>
                </div>
                <div class="flex items-center justify-between mt-1">
                    <button onclick="changeTrack(-1)" class="text-orange-500 hover:text-orange-700 active:scale-90">â®</button>
                    <button onclick="toggleLocalMusic()" id="play-pause-btn" class="text-base text-orange-500 font-black hover:text-orange-700 active:scale-90 mx-2">â–¶</button>
                    <button onclick="changeTrack(1)" class="text-orange-500 hover:text-orange-700 active:scale-90">â­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡å¼B: Bilibili åµŒå…¥æ’­æ”¾å™¨ -->
        <div id="player-bili" class="bili-player">
            <!-- ç›´æ¥åµŒå…¥ç”¨æˆ·æŒ‡å®šçš„ Bç«™è§†é¢‘ -->
            <iframe id="bili-iframe" src="" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width: 100%; height: 100%;"></iframe>
        </div>
    </div>

    <!-- éŸ³é¢‘å¯¹è±¡ (éšè—) -->
    <audio id="bgm-audio" loop></audio>

    <!-- å¼¹çª— -->
    <div id="resume-modal" class="fixed inset-0 bg-black/50 z-50 hidden-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl border-4 border-blue-400 fade-in">
            <div class="text-5xl mb-4">ğŸ’¾</div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">å‘ç°å­˜æ¡£</h3>
            <p class="text-gray-500 text-sm mb-6">ä¸Šæ¬¡ <span id="resume-level-name" class="font-bold text-blue-500">N5</span> æ²¡åšå®Œï¼Œç»§ç»­å—ï¼Ÿ</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="playSound('click'); confirmResume(false)" class="bg-gray-200 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-300">é‡å¼€</button>
                <button onclick="playSound('click'); confirmResume(true)" class="bg-blue-500 text-white font-bold py-3 rounded-xl shadow-[0_4px_0_#1565C0] hover:translate-y-1 active:shadow-none transition-all">ç»§ç»­</button>
            </div>
        </div>
    </div>

    <!-- å‰ç¥¥ç‰© -->
    <div class="mascot-float mb-2 text-center z-10 w-full max-w-md pointer-events-none">
        <div class="flex items-end justify-center">
            <div class="text-7xl filter drop-shadow-xl cursor-pointer relative -mr-4 z-10 pointer-events-auto transition hover:scale-110 active:scale-90" onclick="pokeMascot()">
                ğŸ•
            </div>
            <div class="bg-white px-5 py-3 rounded-2xl rounded-bl-none border-4 border-orange-400 font-bold text-orange-800 shadow-lg relative max-w-[280px] text-sm pointer-events-auto">
                <span id="mascot-dialog">æ¬¢è¿å…‰ä¸´ï¼ä»Šå¤©æƒ³åƒç‚¹ä»€ä¹ˆï¼ŸğŸ£</span>
            </div>
        </div>
    </div>

    <!-- 1. é¦–é¡µ -->
    <div id="screen-home" class="w-full max-w-md fade-in mt-6 relative z-20">
        <div class="bg-white p-6 rounded-3xl shadow-xl border-4 border-orange-100 mb-6 text-center">
            <h1 class="text-3xl font-extrabold text-gray-700 mb-2">æ—¥è¯­å¯¿å¸åº—</h1>
            <p class="text-gray-400 text-sm">ç‚¹å‡»æŒ‰é’®å¬å¬çœ‹æ–°éŸ³æ•ˆï¼ğŸ”Š</p>
        </div>
        
        <div class="space-y-3">
            <button onclick="playSound('click'); checkProgress('N5')" class="w-full btn-cartoon theme-n5 level-card text-white text-xl font-bold py-4 rounded-3xl flex items-center justify-between px-6">
                <div class="flex items-center gap-3"><span class="text-3xl">ğŸµ</span> <span>N5 å…¥é—¨</span></div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">10é¢˜</span>
            </button>
            <button onclick="playSound('click'); checkProgress('N4')" class="w-full btn-cartoon theme-n4 level-card text-white text-xl font-bold py-4 rounded-3xl flex items-center justify-between px-6">
                <div class="flex items-center gap-3"><span class="text-3xl">ğŸ™</span> <span>N4 åŸºç¡€</span></div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">10é¢˜</span>
            </button>
            <button onclick="playSound('click'); checkProgress('N3')" class="w-full btn-cartoon theme-n3 level-card text-white text-xl font-bold py-4 rounded-3xl flex items-center justify-between px-6">
                <div class="flex items-center gap-3"><span class="text-3xl">ğŸ¡</span> <span>N3 ä¸­çº§</span></div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">10é¢˜</span>
            </button>
            <button onclick="playSound('click'); checkProgress('N2')" class="w-full btn-cartoon theme-n2 level-card text-white text-xl font-bold py-4 rounded-3xl flex items-center justify-between px-6">
                <div class="flex items-center gap-3"><span class="text-3xl">ğŸ¤</span> <span>N2 ä¸Šçº§</span></div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">10é¢˜</span>
            </button>
            <button onclick="playSound('click'); checkProgress('N1')" class="w-full btn-cartoon theme-n1 level-card text-white text-xl font-bold py-4 rounded-3xl flex items-center justify-between px-6">
                <div class="flex items-center gap-3"><span class="text-3xl">ğŸ£</span> <span>N1 å¤§å¸ˆ</span></div>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-lg">10é¢˜</span>
            </button>
        </div>
    </div>

    <!-- 2. ç­”é¢˜é¡µ -->
    <div id="screen-quiz" class="hidden-screen w-full max-w-md fade-in pb-10 relative mt-6">
        <button onclick="playSound('click'); saveAndExit()" class="absolute -top-14 right-2 z-40 bg-white text-red-500 px-4 py-2 rounded-full text-sm font-bold border-2 border-red-200 shadow-lg hover:bg-red-50 flex items-center gap-1 active:scale-95 transition-transform">
            <span>ğŸ’¾</span> ä¿å­˜é€€å‡º
        </button>

        <!-- å¯¿å¸æ§½ -->
        <div class="wood-texture w-full h-16 rounded-xl mb-4 border-b-4 border-yellow-700 flex items-center justify-between px-3 relative z-0">
            <div id="sushi-bar-slots" class="flex justify-between w-full"></div>
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-700 text-white text-xs px-3 py-1 rounded-full font-bold shadow-sm">æ”¶é›†è¿›åº¦</div>
        </div>

        <div class="bg-white border-4 border-gray-200 rounded-3xl p-6 shadow-xl mb-4 relative z-0">
            <div class="flex justify-between items-center mb-2">
                <div class="text-gray-400 text-xs font-bold bg-gray-100 px-2 py-1 rounded">Q. <span id="q-number">1</span>/10</div>
                <div id="level-badge" class="font-bold text-blue-500">N5</div>
            </div>
            <p id="question-text" class="text-2xl font-extrabold text-center py-2 mb-2 break-words text-gray-800">é¢˜ç›®åŠ è½½ä¸­...</p>
            <p id="question-sub" class="text-center text-gray-500 mb-2 text-sm">(æç¤ºä¿¡æ¯)</p>
        </div>

        <div id="options-container" class="grid grid-cols-1 gap-3 mb-6"></div>

        <div id="explanation-area" class="hidden-screen bg-orange-50 border-2 border-orange-200 rounded-2xl p-4 mb-6 relative">
            <div class="absolute -top-3 left-4 bg-orange-200 text-orange-800 text-xs font-bold px-2 py-1 rounded">è§£æMEMO</div>
            <p id="explanation-text" class="text-sm text-gray-700 leading-relaxed mt-2"></p>
        </div>

        <button id="next-btn" onclick="playSound('click'); nextQuestion()" class="hidden-screen w-full btn-cartoon bg-gray-800 text-white shadow-[0_6px_0_#000] text-xl font-bold py-3 rounded-2xl">
            ä¸‹ä¸€é¢˜ â¡
        </button>
    </div>

    <!-- 3. ç»“ç®—é¡µ -->
    <div id="screen-result" class="hidden-screen w-full max-w-md fade-in text-center pb-10 mt-6">
        <h2 class="text-2xl font-extrabold text-gray-700 mb-2">æœ¬æ¬¡æ”¶è·</h2>
        
        <div class="bg-red-900 p-2 rounded-[2rem] shadow-2xl mb-6 mx-auto max-w-sm relative">
            <div class="border-2 border-yellow-600 rounded-[1.8rem] p-1 h-full bg-red-800">
                <div id="bento-box" class="bg-black/90 rounded-[1.5rem] p-4 grid grid-cols-2 gap-2 min-h-[300px]"></div>
            </div>
        </div>

        <div class="flex justify-center items-center gap-4 mb-6">
            <div class="text-right">
                <div class="text-xs text-gray-400">æ­£ç¡®ç‡</div>
                <div id="final-score" class="text-3xl font-black text-gray-800">0%</div>
            </div>
            <div class="h-10 w-1 bg-gray-200"></div>
            <div class="text-left">
                <div class="text-xs text-gray-400">è·å¾—ç§°å·</div>
                <div id="result-title" class="text-xl font-bold text-orange-600">-</div>
            </div>
        </div>
        
        <button onclick="playSound('click'); checkProgress(currentLevel, true)" class="w-full btn-cartoon bg-orange-500 text-white shadow-[0_6px_0_#E65100] text-xl font-bold py-3 rounded-2xl mb-3">å†æ¥ä¸€ç›˜</button>
        <button onclick="playSound('click'); goHome()" class="w-full btn-cartoon bg-white text-gray-600 border-2 border-gray-200 shadow-[0_4px_0_#E0E0E0] text-lg font-bold py-3 rounded-2xl">è¿”å›å¤§å…</button>
    </div>

    <script>
        // ----------------- ğŸ”Š éŸ³æ•ˆç³»ç»Ÿ (æ ¸å¿ƒå‡çº§) -----------------
        const SFX = {
            click: new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_736f990921.mp3?filename=bubble-pop-28367.mp3"), // æ°”æ³¡å£°
            correct: new Audio("https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3?filename=success-1-6297.mp3"), // å®å’š
            wrong: new Audio("https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=wrong-answer-129254.mp3"), // å™—
            win: new Audio("https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c153e1.mp3?filename=success-fanfare-trumpets-6185.mp3"), // èƒœåˆ©
            bark: new Audio("https://cdn.pixabay.com/download/audio/2021/08/09/audio_2492167098.mp3?filename=dog-bark-17998.mp3") // ç‹—å«
        };

        // ç»Ÿä¸€æ’­æ”¾å‡½æ•°ï¼Œå¤„ç†éŸ³æ•ˆå¹¶å‘
        function playSound(type) {
            const sound = SFX[type];
            if(sound) {
                sound.currentTime = 0; // æ¯æ¬¡æ’­æ”¾é‡ç½®æ—¶é—´ï¼Œå®ç°è¿ç»­å¿«é€Ÿç‚¹å‡»
                sound.volume = 0.6; // éŸ³æ•ˆä¸éœ€è¦å¤ªå¤§å£°
                sound.play().catch(e => console.log('Wait for interaction'));
            }
        }

        // ----------------- ğŸµ éŸ³ä¹ç³»ç»Ÿ (Bilibili æ¥å…¥) -----------------
        const BGM_LIST = [
            { title: "Ghibli Vibe", url: "https://cdn.pixabay.com/download/audio/2022/03/09/audio_822ca8b454.mp3" },
            { title: "City Pop Vibe", url: "https://cdn.pixabay.com/download/audio/2022/01/26/audio_d0c6ff1bcd.mp3" }
        ];

        // æ‚¨çš„ Bilibili è§†é¢‘ ID
        const BILI_BVID = "BV1Vw4m1S7jT"; 
        let currentMode = 'local'; // 'local' or 'bili'

        function switchMusicMode() {
            playSound('click');
            const localPlayer = document.getElementById('player-local');
            const biliPlayer = document.getElementById('player-bili');
            const modeBtn = document.getElementById('mode-btn');
            const bgmAudio = document.getElementById('bgm-audio');
            const biliIframe = document.getElementById('bili-iframe');

            if (currentMode === 'local') {
                // åˆ‡æ¢åˆ° Bç«™
                currentMode = 'bili';
                bgmAudio.pause(); // æš‚åœæœ¬åœ°
                localPlayer.style.display = 'none';
                biliPlayer.classList.add('active');
                modeBtn.innerText = "ğŸ”„ åˆ‡æ¢å›å†…ç½®è½»éŸ³ä¹";
                // åŠ è½½ Bç«™æ’­æ”¾å™¨ (ä¸è‡ªåŠ¨æ’­æ”¾ï¼Œéœ€ç”¨æˆ·ç‚¹å‡»)
                if (!biliIframe.src) {
                    biliIframe.src = `//player.bilibili.com/player.html?bvid=${BILI_BVID}&page=1&high_quality=1&danmaku=0`;
                }
            } else {
                // åˆ‡æ¢å›æœ¬åœ°
                currentMode = 'local';
                biliPlayer.classList.remove('active');
                localPlayer.style.display = 'flex';
                modeBtn.innerText = "ğŸ”„ åˆ‡æ¢åˆ° Bilibili åŸå£°";
                // åœæ­¢ Bç«™æ’­æ”¾ (ç®€å•ç²—æš´é‡ç½® src)
                const tempSrc = biliIframe.src;
                biliIframe.src = ''; 
                biliIframe.src = tempSrc;
            }
        }

        // ----------------- åŸæœ‰é€»è¾‘ä¿æŒä¸å˜ -----------------
        let currentTrackIdx = 0;
        let isLocalPlaying = false;
        
        const bgmAudio = document.getElementById('bgm-audio');
        bgmAudio.src = BGM_LIST[0].url;
        bgmAudio.volume = 0.4;

        function toggleLocalMusic() {
            if (bgmAudio.paused) {
                bgmAudio.play();
                isLocalPlaying = true;
            } else {
                bgmAudio.pause();
                isLocalPlaying = false;
            }
            updateLocalUI();
        }

        function changeTrack(d) {
            currentTrackIdx = (currentTrackIdx + d + BGM_LIST.length) % BGM_LIST.length;
            bgmAudio.src = BGM_LIST[currentTrackIdx].url;
            if (isLocalPlaying) bgmAudio.play();
            updateLocalUI();
        }

        function updateLocalUI() {
            const btn = document.getElementById('play-pause-btn');
            const disc = document.getElementById('music-disc');
            document.getElementById('music-title').innerText = BGM_LIST[currentTrackIdx].title;
            if (isLocalPlaying) {
                btn.innerText = "â¸";
                disc.classList.add('playing-anim');
            } else {
                btn.innerText = "â–¶";
                disc.classList.remove('playing-anim');
            }
        }

        // ----------------- æ¸¸æˆæ•°æ® -----------------
        const SUSHI_REWARDS = [
            { icon: 'ğŸµ', name: 'çƒ­èŒ¶' }, { icon: 'ğŸ™', name: 'é¥­å›¢' },
            { icon: 'ğŸ¥', name: 'é±¼æ¿' }, { icon: 'ğŸ¥Ÿ', name: 'ç…é¥º' },
            { icon: 'ğŸ¤', name: 'å¤©å¦‡ç½—' }, { icon: 'ğŸ¢', name: 'å…³ä¸œç…®' },
            { icon: 'ğŸ£', name: 'ä¸‰æ–‡é±¼' }, { icon: 'ğŸ±', name: 'è±ªåä¾¿å½“' },
            { icon: 'ğŸ°', name: 'ç”œç‚¹' }, { icon: 'ğŸ†', name: 'æä¸Šæ‹¼ç›˜' }
        ];

        const fullQuestionDB = {
            'N5': [
                { q: 'çŒ«', sub: 'è¯»éŸ³æ˜¯ï¼Ÿ', options: ['ã„ã¬', 'ã­ã“', 'ã¨ã‚Š', 'ã†ã¾'], ans: 1, explain: 'çŒ« (ã­ã“)' },
                { q: 'é£Ÿã¹ã‚‹', sub: 'æ„æ€æ˜¯ï¼Ÿ', options: ['å–', 'çœ‹', 'åƒ', 'è·‘'], ans: 2, explain: 'é£Ÿã¹ã‚‹ (ãŸã¹ã‚‹) = åƒ' },
                { q: 'å·', sub: 'æ„æ€æ˜¯ï¼Ÿ', options: ['æµ·', 'å·', 'å±±', 'ç”°'], ans: 1, explain: 'å· (ã‹ã‚) = æ²³æµ' },
                { q: 'æœ¬', sub: 'è¯»éŸ³æ˜¯ï¼Ÿ', options: ['ã¯ã‚“', 'ã»ã‚“', 'ã°ã‚“', 'ã¼ã‚“'], ans: 1, explain: 'æœ¬ (ã»ã‚“) = ä¹¦' },
                { q: 'å­¦æ ¡', sub: 'è¯»éŸ³æ˜¯ï¼Ÿ', options: ['ãŒã£ã“ã†', 'ãŒã“ã†', 'ã‹ã£ã“ã†', 'ã‹ã“ã†'], ans: 0, explain: 'å­¦æ ¡ (ãŒã£ã“ã†)' },
                { q: 'å…ˆç”Ÿ', sub: 'æ„æ€æ˜¯ï¼Ÿ', options: ['å­¦ç”Ÿ', 'åŒ»ç”Ÿ', 'è€å¸ˆ', 'å¾‹å¸ˆ'], ans: 2, explain: 'å…ˆç”Ÿ (ã›ã‚“ã›ã„) = è€å¸ˆ' },
                { q: 'é«˜ã„', sub: 'è¯»éŸ³æ˜¯ï¼Ÿ', options: ['ãŸã‹ã„', 'ã‚„ã™ã„', 'ãŠã‚‚ã„', 'ã²ãã„'], ans: 0, explain: 'é«˜ã„ (ãŸã‹ã„) = é«˜/è´µ' },
                { q: 'å››ã¤', sub: 'è¯»éŸ³æ˜¯ï¼Ÿ', options: ['ã‚ˆã£ã¤', 'ã‚ˆã¤', 'ã‚ˆã‚“ã¤', 'ã—ã¤'], ans: 0, explain: 'å››ã¤ (ã‚ˆã£ã¤) = 4ä¸ª' },
                { q: 'é›¨', sub: 'æ„æ€æ˜¯ï¼Ÿ', options: ['é›ª', 'é£', 'äº‘', 'é›¨'], ans: 3, explain: 'é›¨ (ã‚ã‚) = é›¨' },
                { q: 'å…ƒæ°—', sub: 'è¯»éŸ³æ˜¯ï¼Ÿ', options: ['ã¦ã‚“ã', 'ã’ã‚“ã', 'ã³ã‚‡ã†ã', 'ã‚†ã†ã'], ans: 1, explain: 'å…ƒæ°— (ã’ã‚“ã) = ç²¾ç¥/å¥åº·' }
            ]
        };

        // ----------------- æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (çŠ¶æ€ç®¡ç†) -----------------
        let currentLevel = '';
        let quizQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let earnedSushiList = [];
        const mascotDialog = document.getElementById('mascot-dialog');

        function checkProgress(level, forceRestart = false) {
            currentLevel = level;
            const savedData = localStorage.getItem(`quiz_save_${level}`);
            if (!forceRestart && savedData) {
                document.getElementById('resume-level-name').innerText = level;
                document.getElementById('resume-modal').classList.remove('hidden-screen');
            } else {
                startNewQuiz(level);
            }
        }

        function confirmResume(shouldResume) {
            document.getElementById('resume-modal').classList.add('hidden-screen');
            shouldResume ? loadSavedQuiz(currentLevel) : startNewQuiz(currentLevel);
        }

        function saveProgress() {
            if (currentIndex >= 10) return;
            const state = { questions: quizQuestions, index: currentIndex, score: score, sushi: earnedSushiList, timestamp: new Date().getTime() };
            localStorage.setItem(`quiz_save_${currentLevel}`, JSON.stringify(state));
        }

        function clearProgress(level) { localStorage.removeItem(`quiz_save_${level}`); }

        function startNewQuiz(level) {
            let pool = fullQuestionDB[level] || fullQuestionDB['N5'];
            while(pool.length < 10) { pool = pool.concat(pool); }
            quizQuestions = shuffleArray(pool).slice(0, 10);
            currentIndex = 0; score = 0; earnedSushiList = new Array(10).fill(null);
            clearProgress(level);
            enterQuizScreen();
        }

        function loadSavedQuiz(level) {
            const data = JSON.parse(localStorage.getItem(`quiz_save_${level}`));
            if (!data) return startNewQuiz(level);
            quizQuestions = data.questions; currentIndex = data.index; score = data.score; earnedSushiList = data.sushi;
            mascotDialog.innerText = `æ¬¢è¿å›æ¥ï¼ç»§ç»­ ${level} çš„æŒ‘æˆ˜ï¼`;
            enterQuizScreen();
        }

        function enterQuizScreen() {
            updateUITheme(currentLevel);
            showScreen('screen-quiz');
            renderSushiBar();
            loadQuestion();
        }

        function saveAndExit() {
            if (!currentLevel) { goHome(); return; }
            saveProgress();
            mascotDialog.innerText = "è¿›åº¦å·²ä¿å­˜ï¼ä¸‹æ¬¡è§ï¼ğŸ•";
            setTimeout(goHome, 200);
        }

        function loadQuestion() {
            document.getElementById('next-btn').classList.add('hidden-screen');
            document.getElementById('explanation-area').classList.add('hidden-screen');
            const qData = quizQuestions[currentIndex];
            document.getElementById('q-number').innerText = currentIndex + 1;
            document.getElementById('question-text').innerText = qData.q;
            document.getElementById('question-sub').innerText = qData.sub;

            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';
            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `w-full bg-white border-b-4 border-gray-200 p-4 rounded-xl text-lg font-bold text-gray-600 hover:bg-gray-50 transition active:border-b-0 active:translate-y-1 mb-2`;
                btn.innerText = opt;
                btn.onclick = () => { playSound('click'); checkAnswer(idx, btn); };
                optionsDiv.appendChild(btn);
            });
            saveProgress();
        }

        function checkAnswer(selectedIdx, btnElement) {
            const qData = quizQuestions[currentIndex];
            const correctIdx = qData.ans;
            const allBtns = document.getElementById('options-container').querySelectorAll('button');
            allBtns.forEach(b => {
                b.disabled = true;
                b.classList.add('cursor-default', 'opacity-80');
                b.classList.remove('hover:bg-gray-50');
            });

            const reward = SUSHI_REWARDS[currentIndex];
            if (selectedIdx === correctIdx) {
                score++;
                playSound('correct'); // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
                btnElement.classList.add('opt-correct', 'pop-in');
                btnElement.classList.remove('opacity-80');
                mascotDialog.innerText = `å¥½æ£’ï¼${reward.name} Getï¼ğŸ˜‹`;
                earnedSushiList[currentIndex] = reward;
                updateSushiSlot(currentIndex, reward, true);
            } else {
                playSound('wrong'); // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                btnElement.classList.add('opt-wrong');
                btnElement.classList.remove('opacity-80');
                allBtns[correctIdx].classList.add('opt-correct');
                allBtns[correctIdx].classList.remove('opacity-80');
                mascotDialog.innerText = "æ²¡å…³ç³»ï¼çœ‹è§£æï¼ğŸ‘€";
                updateSushiSlot(currentIndex, null, false);
            }

            document.getElementById('explanation-text').innerText = qData.explain;
            document.getElementById('explanation-area').classList.remove('hidden-screen');
            document.getElementById('explanation-area').classList.add('fade-in');
            
            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.remove('hidden-screen');
            nextBtn.classList.add('fade-in');
            nextBtn.innerText = (currentIndex === 9) ? "æŸ¥çœ‹æˆ˜åˆ©å“ ğŸ±" : "ä¸‹ä¸€é¢˜ â¡";
            saveProgress();
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < 10) {
                loadQuestion();
                mascotDialog.innerText = `ç¬¬ ${currentIndex + 1} é“èœæ¥å•¦ï¼`;
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            playSound('win'); // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ
            clearProgress(currentLevel);
            showScreen('screen-result');
            renderBentoBox();
            const percentage = Math.round((score / 10) * 100);
            document.getElementById('final-score').innerText = `${percentage}%`;
            let title = score >= 8 ? "å¯¿å¸ä¹‹ç¥" : (score >= 5 ? "å¯¿å¸å¸ˆå‚…" : "å­¦å¾’");
            document.getElementById('result-title').innerText = title;
            mascotDialog.innerText = "å¤šè°¢æ¬¾å¾…ï¼ğŸ™";
        }

        // ----------------- é€šç”¨è¾…åŠ© -----------------
        function renderSushiBar() {
            const container = document.getElementById('sushi-bar-slots');
            container.innerHTML = '';
            for(let i=0; i<10; i++) {
                const slot = document.createElement('div');
                slot.id = `slot-${i}`;
                slot.className = "w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-sm bg-white/40 shadow-inner";
                if (i < currentIndex) {
                    const item = earnedSushiList[i];
                    item ? (slot.innerHTML = item.icon, slot.classList.add('bg-white')) : (slot.innerHTML = "âŒ", slot.classList.add('text-red-500'));
                } else {
                    slot.innerText = "â—"; slot.classList.add('text-gray-400');
                }
                container.appendChild(slot);
            }
        }

        function updateSushiSlot(idx, reward, isCorrect) {
            const slot = document.getElementById(`slot-${idx}`);
            slot.classList.remove('text-gray-400');
            if (isCorrect) {
                slot.innerHTML = reward.icon; slot.classList.add('pop-in', 'bg-white');
            } else {
                slot.innerHTML = "âŒ"; slot.classList.add('pop-in', 'text-red-500');
            }
        }

        function renderBentoBox() {
            const box = document.getElementById('bento-box');
            box.innerHTML = '';
            earnedSushiList.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex flex-col items-center justify-center p-2 rounded-xl bg-gray-800 border border-gray-700 h-24";
                item ? (div.innerHTML = `<div class="text-4xl pop-in">${item.icon}</div><div class="text-xs text-yellow-500 mt-1">${item.name}</div>`) 
                     : (div.innerHTML = `<div class="text-3xl opacity-20 grayscale">ğŸ½ï¸</div>`);
                box.appendChild(div);
            });
        }

        function showScreen(screenId) {
            ['screen-home', 'screen-quiz', 'screen-result'].forEach(id => document.getElementById(id).classList.add('hidden-screen'));
            document.getElementById(screenId).classList.remove('hidden-screen');
            document.getElementById(screenId).classList.add('fade-in');
        }

        function updateUITheme(level) {
            const colors = {'N5': '#2979FF', 'N4': '#FFAB40', 'N3': '#00E676', 'N2': '#7C4DFF', 'N1': '#FF5252'};
            const color = colors[level] || '#2979FF';
            document.getElementById('level-badge').innerText = level;
            document.getElementById('level-badge').style.color = color;
        }

        function shuffleArray(arr) {
            let newArr = [...arr];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }
        
        function pokeMascot() {
            playSound('bark');
            mascotDialog.innerText = "æ±ªæ±ªï¼(æƒ³è¦éª¨å¤´)";
        }

        function goHome() {
            showScreen('screen-home');
        }
    </script>
</body>
</html>